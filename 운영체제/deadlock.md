# 데드락 (Deadlock)

## Deadlock 이란

+ 데드락(교착상태)란, 시스템 자원에 대한 요구가 뒤엉킨 상태를 의미한다.
+ 둘 이상의 프로세스가 다른 프로세스가 점유하고 있는 자원을 서로 기다릴 때 무한 대기에 빠지는 상황이다.
+ 시스템적으로 한정된 자원을 여러 곳에서 사용하려 하지만, 자신이 원하는 리소스가 상대방에게 할당되어 있기 때문에 프로세스가 진행되지 못한다.

<br>

## 데드락이 발생할 수 있는 경우 

<br>

+ 프로세스1과 2가 자원1, 자원2 를 모두 얻어야 하는 상황이라면
  - t1 : 프로세스1이 자원1을 얻음 / 프로세스2가 자원2를 얻음
  - t2 : 프로세스1은 자원2를 기다림 / 프로세스2가 자원1을 기다림
  - 이 상태가 무한히 지속됨
+ 멀티 프로그래밍 환경에서 한정된 자원을 얻기 위해 서로 경쟁하는 상황
+ 한 프로세스가 자원을 요청했을 때, 동시에 그 자원을 사용할 수 없는 상황이 되어버리는 경우
+ 대기 상태로 들어간 프로세스들이 실행 상태로 변경될 수 없을 때

<br>

## 데드락 발생 조건

+ 다음의 4가지가 모두 성립해야 데드락이 발생한다.
  - 하나라도 성립하지 않으면 해결 가능하다.

+ 상호 배제 (Mutual Exclusion)
  - 자원은 한 번에 하나의 프로세스만 사용할 수 있다.

+ 점유 대기 (Hold and Wait)
  - 최소한 하나의 자원을 점유하고 있으면서 다른 프로세스에 할당되어 사용하고 있는 자원을 추가로 점유하기 위해 대기하는 프로세스가 있어야 한다.

+ 비선점 (No Preemption)
  - 다른 프로세스에 할당된 자원은 사용이 끝날 때 까지 강제로 빼앗을 수 없어야 한다.

+ 순환 대기 (Circular Wait)
  - 프로세스의 집합 {P0, P1, P2, ...., Pn}에서 P0는 P1이 점유한 자원을 대기하고, P1은 P2가 점유한 자원을 대기하고, ... , Pn-1은 Pn이 점유한 자원을 대기하며 Pn은 P0가 점유한 자원을 요구해야 한다.

<br>

## 데드락의 해결 방법

+ 데드락의 해결방법은 크게 3가지로 분류할 수 있다.
  - 데드락이 발생하지 않도록 예방(Prevention) 하기
    - 교착 상태가 되지 않도록 한다.
  - 데드락 발생 가능성을 인정하며 적절하게 회피(Avoidance) 하기
  - 데드락 발생을 허용하지만, 데드락을 탐지(Detection)하고 회복(Recovery)하기
    - 교착 상태가 탐지되면 시스템에 문제가 발생하지 않도록 조치를 취한다.
  - 데드락 무시
    - 교착 상태가 발생하도록 하고 필요에 따라 재부팅하도록 한다.

### 데드락 예방 (Prevention)

+ 데드락의 발생 조건 4가지 중 하나라도 발생하지 않도록 데드락 자체를 예방하는 것이다. 각각의 조건을 방지(부정)하여 데드락 발생 가능성을 차단한다.
  - 자원의 상호 배제 조건 방지
    + 한 번에 여러 프로세스가 공유 자원을 사용할 수 있도록 한다.
    + 동기화 관련 문제가 발생할 수 있다.
  - 점유 대기 조건 방지
    + 프로세스 실행에 필요한 모든 자원을 한꺼번에 요구하고 허용할 때 까지 작업을 보류하여, 나중에 또 다른 자원을 점유하기 위한 대기 조건을 성립하지 않도록 한다. 
    + 프로세스가 실행되기 전에 모든 자원을 할당해버린다는 뜻
  - 비선점 조건 방지
    + 이미 다른 프로세스에게 할당된 자원이 선점권이 없다고 가정할 때, 높은 우선순위의 프로세스가 해당 자원을 선점할 수 있도록 한다.
  - 순환 대기 조건 방지
    + 자원을 순환 형태로 대기하지 않도록 일정한 한 쪽 방향으로만 자원을 요구할 수 있도록 한다.

+ 하지만 예방의 각 방식들은 시스템의 처리량이나 효율성을 떨어트린다는 단점이 있다.

### 데드락 회피 (Avoidance)

+ 안정 상태 (Safe State)
  - 시스템의 프로세스들이 요청하는 모든 자원을 데드락을 발생시키지 않으면서도 차례로 모두에게 할당해줄 수 있는 상태
  - 회피 알고리즘은 자원을 할당한 후에도 시스템이 항상 Safe State에 있을 수 있도록 할당을 허용한다.
+ 안전 순서 (Safe Sequence)
  - 특정한 순서로 프로세스들에게 자원을 할당, 실행, 종료 등의 작업을 할 때 데드락이 발생하지 않는 순서

+ 불안정 상태
  - 안정 상태가 아닌 상황. 데드락 발생 가능성이 있는 상황
  - 오직 불안정 상태에서만 교착 상태가 일어날 수 있다.

+ 은행원 알고리즘 (Banker's Algorithm)
  + 어떤 자원의 할당을 허용하는지에 관한 여부를 결정하기 전에, 미리 결정된 모든 자원들의 최대 가능한 할당량을 가지고 시뮬레이션하여 Safe State에 들 수 있는지에 대한 여부를 검사한다.
  + 대기 중의 다른 프로세스들의 활동에 대한 교착 상태 가능성을 미리 조사하는 것이다.
  + 안정 상태면 자원을 할당하고, 아니라면 다른 프로세스들이 자원을 내놓을 때 까지 대기한다. 

### 데드락 탐지(Detection) 및 회복(Recovery)

+ 데드락을 예방하거나 회피하지 않고, 데드락 발생을 탐지 및 회복하는 알고리즘을 사용한다.
+ 탐지 기법
  - Allocation, Request, Available 등으로 시스템에 데드락이 발생했는지에 대한 여부를 탐색한다.
  - 현재 시스템의 자원 할당 상태를 통해 파악할 수 있다.
  - 자원 할당 그래프를 통해 탐지할 수도 있다.
+ 회복 기법
  - 탐지가 되었다면, 순환 대기에서 벗어나 데드락으로부터 회복하기 위한 방법을 사용한다.
  - 프로세스를 1개 이상 중단시키기
    + 교착 상태에 빠진 모든 프로세스를 중단시키기 : 연산 중이던 프로세스들이 모두 일시에 중단되어 결과가 폐기될 수도 있다.
    + 프로세스를 하나 씩 중단시키면서 알고리즘으로 데드락 탐지 및 회복 : 매번 탐지 알고리즘을 호출, 수행해야 하므로 부담이 클 수 있다.
  - 자원 선점하기
    + 프로세스에 할당된 자원을 선점하여 교착 상태를 해결할 때 까지 해당 자원을 다른 프로세스에게 할당해준다. 
    + 우선순위가 낮거나 수행 횟수가 적은 프로세스 위주로 프로세스 자원을 선점한다.

### 데드락 무시

- 교착 상태가 정말 드물게 발생하는 경우(1년에 한번) 교착 상태 예방 또는 탐지와 관련된 지속된 오버헤드 및 성능 저하를 발생 시키는 것보다 교착 상태가 발생하도록 하고 필요에 따라 재부팅하는 것이 더 나을 수 있다.
  (Unix 및 window를 포함한 대부분의 운영체제가 사용하는 방법)
